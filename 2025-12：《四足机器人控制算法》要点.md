# 《四足机器人控制算法》要点

年份：2025

- 一、概述与实践准备
    1. 四足机器人组成 ···················· P4
        - 动力系统：关节电机
        - 控制系统：硬件+软件，软件分为规划器和运动控制器
        - 通讯系统
        - 能源系统：电池
    
- 二、关节电机
    1. 永磁同步电机 ···················· P4
        - 其他电机类型：异步电机（不精确）、步进电机（只对角度精确）
        - 原理：固定磁场中，永磁体会旋转并保持在平行于磁场的方向（指南针+地球）。改变磁场的方向，即改变磁场与永磁体之间的夹角，形成力矩。
    
    1. FOC（Field-Oriented Control） ···················· P4
        - 中文为永磁同步电机的矢量控制。像素级控制，精确，噪声小。
        - 原理：三个电流线圈产生三个方向磁场，所合成的总磁场方向，拖动转子按期望方式运动。
        
    2. 电机结构 ···················· P5
       
        减速器。作用：使电机转子（高转速、低力矩），经过减速，到达机器人（低转速、高力矩）。
        
    3. 单圈绝对位置编码器 ···················· P5
        1. 能够储存圈数
        2. 断电删除圈数
    
    1. 关节电机混合控制 ···················· P6
       
        五个控制量：（需在电机运行模式为“闭环伺服控制”下起作用）
        
        - $τ_{ff}$（前馈力矩）
        - $K$（位置刚度）
        - $q_{des}$（期望角度位置）
        - $D$（速度刚度/阻尼）
        - $\dot{q_{des}}$（期望角速度）
        
        输出量：
        
        - $τ_{cmd}$（输出力矩）
        
        状态量：
        
        - $q$（当前角度位置）
        - $\dot{q}$（当前角速度）
        
        $$
        \tau_{\mathrm{cmd}}=\tau_{f f}+K\left(q_{\mathrm{des}}-q\right)+D\left(\dot{q}_{\mathrm{des}}-\dot{q}\right)
        $$
        
    2. 电机控制模式 ···················· P11
        - 位置模式
        - 速度模式
        - 阻尼模式（默认开机状态）
        - 力矩模式
        - 零力矩模式
        - 混合模式（位置、速度、力矩的混合控制。PD控制器。）
    
- 三、仿真与控制框架
    1. 面向对象的应用 ···················· P20
       
        通常会有仿真和真机2种模式，二者继承同一父类接口，外层代码不需要改。
        
    1. 有限状态机 ···················· P22
       
        继承同一个父类，实现如下接口：
        
        - enter：刚进此状态执行一次
        - run：进入后循环调用
        - exit：退出时执行一次
        - checkChange：检查是否需要切换进其他状态
    
    1. 关节排序与坐标轴 ···················· P25, 28
        - 腿顺序：0-右前，1-左前，2-右后，3-左后
        - 关节顺序：0-机身，1-大腿，2-小腿
        - 旋转轴方向：平行的，均为x前y左z上
        - 关节旋转轴：机身绕x轴，大腿和小腿绕y轴
    
    1. 网络配置 ···················· P34
        1. 交换机和路由器：交换机实现多个计算机内部通讯，路由器可以连到互联网。路由器通常包括交换机的同能。LAN（局域网），WAN（广域网）。
        2. 配置固定IP
           
            ```bash
            sudo ifconfig eth0 down
            sudo ifconfig etho9 up 192.168.123.162 netmask 255.255.25
            ```
            
        3. 开机自动配置固定IP
           
            ```bash
            sudo vim /etc/network/interfaces
            ```
            
            ```bash
            # 添加如下内容
            auto eth0
            iface eth0 inet static
            address 192.168.123.162
            netmask 255.255.25
            ```
            
        4. 网关
            1. 新路由器未配置时默认IP通常是192.168.0.1。
            2. 网关可以理解为就是路由器的IP地址。其他计算机通过这个出口连接互联网。
        5. DNS
            1. ping 域名的时候未必成功，需要DNS解析
            2. DNS服务器
               
                ```bash
                ping 202.38.64.1      # 中科大
                ping 114.114.114.114  # 我国常用
                ping 8.8.8.8          # Google
                ```
                
            3. 配置
               
                ```bash
                sudo vim /etc/network/interfaces
                ```
                
                ```bash
                dns-nameservers 8.8.8.8
                ```
    
- 四、刚体运动学
    1. 三维空间旋转矩阵   ···················· P45
       
        在一个坐标系下，任意向量都可以用单位向量来表示：
        
        $$
        \overrightarrow{OP} = x_s \cdot \hat{\boldsymbol{x}}_s + y_s + \hat{\boldsymbol{y}}_s 
        $$
        
        旋转矩阵=新坐标系的单位向量在参考坐标系下的坐标（通常通过三角函数获得）
        
        ![image.png](image/2025-12/image.png)
        
        ![image.png](image/2025-12/image%201.png)
        
        ![image.png](image/2025-12/image%202.png)
        
        旋转矩阵特性：
        
        - $det(R)=1$，行列式=1（旋转矩阵不缩放物体）
        - $R^{-1} = R^{T}$，逆=转置（反向旋转尽量不要用逆矩阵，而用转置矩阵）
        
    2. 向量积   ···················· P48
       
        $$
        \boldsymbol{c} = \boldsymbol{a} \times \boldsymbol{b} \\
        |\boldsymbol{c}| = |\boldsymbol{a}|  |\boldsymbol{b}|sin\theta
        $$
        
        向量$\boldsymbol{c}$方向：右手四指指向$\boldsymbol{a}$，向$\boldsymbol{b}$方向握拳，大拇指方向
        
        模长含义：平行四边形面积
        
        特性： $\boldsymbol{a} \times \boldsymbol{b} = -\boldsymbol{b} \times \boldsymbol{a}$
        
        变形：根据单位向量的叉乘特性（此处略），可将第一个向量变为一个反对称矩阵，记为符号 $[\boldsymbol{a}]_{\mathrm{x}}$
        
        $$
        \begin{aligned}\boldsymbol{a} \times \boldsymbol{b} & =\left[\begin{array}{c}0 \cdot b_x+\left(-a_z\right) \cdot b_y+a_y \cdot b_z \\a_z \cdot b_x+0 \cdot b_y+\left(-a_x\right) \cdot b_z \\\left(-a_y\right) \cdot b_x+a_x \cdot b_y+0 \cdot b_z\end{array}\right] \\& =\left[\begin{array}{ccc}0 & -a_z & a_y \\a_z & 0 & -a_x \\-a_y & a_x & 0\end{array}\right] \cdot \boldsymbol{b} \\& =[\boldsymbol{a}]_{\mathrm{x}} \cdot \boldsymbol{b}\end{aligned}
        $$
        
    3. 绕轴旋转质点速度   ···················· P50
       
        根据线速度=角速度*半径，得到
        
        $$
        |\boldsymbol{v}_{\omega}| = |\boldsymbol{\omega}| \cdot |\boldsymbol{p}| \cdot sin \angle AOP
        $$
        
        ![image.png](image/2025-12/image%203.png)
        
        模长恰好为向量积模长，加上方向，得：
        
        $$
        \boldsymbol{v}_{\omega} = \boldsymbol{\omega}\times \boldsymbol{p} = [\boldsymbol{\omega}]_{\times } \boldsymbol{p}
        $$
        
        含义：质点线速度等于绕轴角速度叉乘质点坐标
        
    1. 罗德里格斯公式：轴-角表示法与旋转矩阵的互换
    
    1. 欧拉角   ···················· P50
       
        与旋转矩阵互换，一般按Y-P-R顺序
        
        ![image.png](/image%204.png)
        
    
- 五、单腿的运动学和静力学
    1. 正运动学  ···················· P66
       
        单看一条腿。关节角度→足端坐标。
        
        定义四个坐标系{0} {1} {2} {3}，{0}是基座坐标系，{1} {2} {3}分别是三个连杆的坐标系。{0} {1} {2}共用一个原点。 四个坐标系轴方向都是x前y左z上。
        
        ![image.png](image/2025-12/image%205.png)
        
        机身关节、髋关节、膝关节分别旋转 $\theta_1$、$\theta_2$、$\theta_3$，按照4.1的方法，得到足端坐标相对机身关节坐标：
        
        $$
        \left[\begin{array}{c}x_P \\y_P \\z_P \\1\end{array}\right]=\left[\begin{array}{c}l_3 \sin \left(\theta_2+\theta_3\right)+l_2 \sin \theta_2 \\-l_3 \sin \theta_1 \cos \left(\theta_2+\theta_3\right)+l_1 \cos \theta_1-l_2 \cos \theta_2 \sin \theta_1 \\l_3 \cos \theta_1 \cos \left(\theta_2+\theta_3\right)+l_1 \sin \theta_1+l_2 \cos \theta_1 \cos \theta_2 \\1\end{array}\right]
        $$
        
        - $l_1, l_2,l_3$：连杆长度。髋长、大腿长、小腿长。
          
            $$
            l_1= \begin{cases}-l_{\mathrm{abad}}, & \text { 右前腿, 右后腿 } \\ l_{\mathrm{abad}}, & \text { 左前腿, 左后腿 }\end{cases}, l_2=-l_{\mathrm{hip}}, l_3=l_{\mathrm{knee}}
            $$
            
        - 推导过程：刚体运动学
          
          
            {0}→{1}：绕x转 $\theta_1$
            
            $$
            \boldsymbol{T}_{01}=\left[\begin{array}{cccc}1 & 0 & 0 & 0 \\0 & \cos \theta_1 & -\sin \theta_1 & 0 \\0 & \sin \theta_1 & \cos \theta_1 & 0 \\0 & 0 & 0 & 1\end{array}\right]
            $$
            
            {1}→{2}：绕y转  $\theta_2$
            
            $$
            \boldsymbol{T}_{12}=\left[\begin{array}{cccc}\cos \theta_2 & 0 & \sin \theta_2 & 0 \\0 & 1 & 0 & 0 \\-\sin \theta_2 & 0 & \cos \theta_2 & 0 \\0 & 0 & 0 & 1\end{array}\right]
            $$
            
            {2}→{3}：绕y转 $\theta_3$（右腿为例）
            
            $$
            \boldsymbol{T}_{23}=\left[\begin{array}{cccc}\cos \theta_3 & 0 & \sin \theta_3 & 0 \\0 & 1 & 0 & l_1 \\-\sin \theta_3 & 0 & \cos \theta_3 & l_2 \\0 & 0 & 0 & 1\end{array}\right]
            $$
            
            足端在{3}的坐标：
            
            $$
            \left[\begin{array}{c}\boldsymbol{p}_3 \\1\end{array}\right]=\left[\begin{array}{c}0 \\0 \\l_3 \\1\end{array}\right]
            $$
            
        
    2. 逆运动学  ···················· P69
       
        足端坐标→关节角度。
        
        求解顺序： $\theta_1$、$\theta_3$、 $\theta_2$
        
        $$
        \theta_1=\operatorname{atan} 2\left(z_p l_1+y_p L, y_p l_1-z_p L\right)
        $$
        
        $$
        \theta_3=-\pi+\operatorname{acos}\left(\frac{l_{hip}^2+l_{knee}^2-|\overrightarrow{AP}|^2}{2l_{hip}l_{knee}}\right)
        $$
        
        $$
        \theta_2=\operatorname{atan2}\left(a_1 m_1+a_2 m_2, a_2 m_1-a_1 m_2\right)
        $$
        
        - $L$：机器人腿部（大腿和小腿）在yz平面投影长度，根据勾股定理
          
            $$
            L=\sqrt{y_p^2+z_p^2-l_1^2}
            $$
            
        - $|\overrightarrow{AP}|$：O点在A点里侧，∠OAP是直角，根据勾股定理
          
            $$
            |\overrightarrow{AP}|=\sqrt{(x_{P}^2+y_{P}^2+z_{P}^2-l_{abad}^2)}
            $$
            
        - $a$和 $m$：
        
        $$
        \left\{\begin{array}{l}a_{1}=y_{p} \sin \theta_{1}-z_{p} \cos \theta_{1} \\a_{2}=x_{p} \\m_{1}=l_{3} \sin \theta_{3} \\m_{2}=l_{3} \cos \theta_{3}+l_{2}\end{array}\right.
        $$
        
        - 推导过程：几何学
          
          
            单腿前视图：
            
            ![image.png](image/2025-12/image%206.png)
            
            单腿侧视图：
            
            ![image.png](image/2025-12/image%207.png)
            
        
    1. 一阶微分运动学和静力学  ···················· P72
       
        足端线速度与关节角速度是线性关系，二者可以通过雅可比矩阵$\boldsymbol{J}$互推。 $\boldsymbol{J}=\boldsymbol{J}(\theta)$，仅与关节旋转角度有关。
        
        $$
        \left[\begin{array}{l}
        \dot{x}_{P} \\
        \dot{y}_{P} \\
        \dot{z}_{P}
        \end{array}\right]=\left[\begin{array}{lll}
        J_{11} & J_{12} & J_{13} \\
        J_{21} & J_{22} & J_{23} \\
        J_{31} & J_{32} & J_{33}
        \end{array}\right] \cdot\left[\begin{array}{l}
        \dot{\theta}_{1} \\
        \dot{\theta}_{2} \\
        \dot{\theta}_{3}
        \end{array}\right]=\boldsymbol{J} \cdot\left[\begin{array}{l}
        \dot{\theta}_{1} \\
        \dot{\theta}_{2} \\
        \dot{\theta}_{3}
        \end{array}\right]
        $$
        
        $$
        \left[\begin{array}{l}
        \dot{\theta}_{1} \\
        \dot{\theta}_{2} \\
        \dot{\theta}_{3}
        \end{array}\right]=\boldsymbol{J}^{-1} \cdot\left[\begin{array}{l}
        \dot{x}_{P} \\
        \dot{y}_{P} \\
        \dot{z}_{P}
        \end{array}\right]
        $$
        
        - 推导过程：对 “5.1 正运动学” 中的足端坐标关节角度等式两边求导
          
            ![image.png](image/2025-12/image%208.png)
            
        
    2. 单腿静力学  ···················· P73
       
        足端力和关节力矩也是线性关系。二者可以通过雅可比矩阵互推。
        
        $$
        \begin{gathered}{\left[\begin{array}{lll}\tau_1 & \tau_2 & \tau_3\end{array}\right] \cdot\left[\begin{array}{l}\dot{\theta}_1 \\\dot{\theta}_2 \\\dot{\theta}_3\end{array}\right]=\left[\begin{array}{lll}F_x & F_y & F_z\end{array}\right] \cdot\left[\begin{array}{l}\dot{x}_P \\\dot{y}_P \\\dot{z}_P\end{array}\right]} \\\boldsymbol{\tau}^{\mathrm{T}} \cdot\left[\begin{array}{l}\dot{\theta}_1 \\\dot{\theta}_2 \\\dot{\theta}_3\end{array}\right]=\boldsymbol{F}^{\mathrm{T}} \cdot \boldsymbol{J} \cdot\left[\begin{array}{l}\dot{\theta}_1 \\\dot{\theta}_2 \\\dot{\theta}_3\end{array}\right] \\\boldsymbol{\tau}=\boldsymbol{J}^{\mathrm{T}} \cdot \boldsymbol{F}\end{gathered}
        $$
        
        - 推导过程：力学公式
          
            (力 * 半径) * 角速度 = 力矩 * 角速度
            
            力 * (半径 * 角速度) = 力 * 线速度
            
            ∴ 力矩 * 角速度 = 力 * 线速度
            
        
    3. 摆动腿修正力  ···················· P74
       
        对于腾空腿，可应用上述原理，根据（规划的）足端目标位置和目标速度，求出关节角度和关节角速度。但调参不方便，因此还需对其足端的目标位置与目标速度的差距施加修正力：
        
        $$
        \boldsymbol{f}_d=\boldsymbol{K}_{\mathrm{p}}\left(\boldsymbol{p}_{0 d}-\boldsymbol{p}_{0 f}\right)+\boldsymbol{K}_{\mathrm{d}}\left(\dot{\boldsymbol{p}}_{0 d}-\dot{\boldsymbol{p}}_{0 f}\right)
        $$
        
    
- 六、四足机器人的运动学与动力学
    1. 机身坐标系与世界坐标系   ···················· P77
       
        机身坐标系{b}，是一个惯性系（不平移旋转），但是时刻与机器人位姿重合。
        
        一般建立在重心上。   ···················· P80
        
        世界坐标系{s}，也是一个惯性系，选择初始状态下某一只脚为原点的坐标系。
        
        只有惯性系中才能使用牛顿第二定律。
        
    1. 刚体上某个质点的速度与加速度   ···················· P78
       
        质点不考虑旋转，只考虑速度和加速度。
        
        刚体上质点的速度 = 刚体平移速度 + 刚体旋转产生的速度。加速度同理。
        
        $$
        \begin{aligned}& \dot{\boldsymbol{p}}_P=\boldsymbol{v}_b+\left[\boldsymbol{\omega}_b\right]_{\times} \boldsymbol{p}_P \\& \ddot{\boldsymbol{p}}_P=\dot{\boldsymbol{v}}_b+\left[\dot{\boldsymbol{\omega}}_b\right]_{\times} \boldsymbol{p}_P+\left[\boldsymbol{\omega}_b\right]_{\times}\left[\boldsymbol{\omega}_b\right]_{\times} \boldsymbol{p}_P\end{aligned}
        $$
        
        - $v_b$：刚体平移线速度
        - $\omega_b$：刚体旋转角速度
        - 推导过程：
          
            $$
            \begin{aligned}&（1）根据第4章绕轴旋转质点速度\\ &\dot{\boldsymbol{p}}_P=\boldsymbol{v}_b+\left[\boldsymbol{\omega}_b\right]_x\left(\boldsymbol{p}_P-\boldsymbol{p}_{O^{\prime}}\right)\\
            
            &（2）对（1）求导\\
            &\ddot{\boldsymbol{p}}_P=\dot{\boldsymbol{v}}_b+\left[\dot{\boldsymbol{\omega}}_b\right]_{\times}\left(p_{P^{\prime}}-p_{O^{\prime}}\right)+\left[\omega_b\right]_{\times}\left(\dot{p}_{P^{\prime}}-\dot{p}_{O^{\prime}}\right)\\
            
            &（3）将（1）代入（2）\\
            &\ddot{\boldsymbol{p}}_P=\dot{\boldsymbol{v}}_b+\left[\dot{\boldsymbol{\omega}}_b\right]_{\times}\left(\boldsymbol{p}_P-\boldsymbol{p}_{o^{\prime}}\right)+\left[\boldsymbol{\omega}_b\right]_{\times}\left[\boldsymbol{\omega}_b\right]_{\times}\left(\boldsymbol{p}_P-\boldsymbol{p}_{o^{\prime}}\right)\\
            
            &（4） O'坐标为0\\
            &\boldsymbol{p}_{o^{\prime}} = 0 \ \ 
            \\
            
            &（5）将（4）带入（1）和（3）\\
            &\dot{\boldsymbol{p}}_P=\boldsymbol{v}_b+\left[\boldsymbol{\omega}_b\right]_{\times} \boldsymbol{p}_P \\
            
            &\ddot{\boldsymbol{p}}_P=\dot{v}_b+\left[\dot{\boldsymbol{\omega}}_b\right]_{\times} \boldsymbol{p}_P+\left[\boldsymbol{\omega}_b\right]_{\times}\left[\boldsymbol{\omega}_b\right]_{\times} \boldsymbol{p}_P
            \end{aligned}
            $$
            
    
    1. 机身运动时足端速度   ···················· P79
       
        机身运动时的足端速度 = 机身平移导致的足端牵连速度（6.2 刚体质点速度 ）+关节旋转导致的足端速度（5.3节  一阶微分运动学）
        
        $$
        v_{bej}\begin{aligned}
        & \\
        &= v_{be} + v_{bj}\\
        &= v_b + [\boldsymbol{\omega}_b]_{\times} \boldsymbol{p_{bj}} + \boldsymbol{J}\dot{\theta} \\
        \end{aligned}
        $$
        
        进而可进一步通过坐标变换，变换到世界坐标系下足端速度，此处略。
        
    1. 单刚体动力学   ···················· P80
       
        单刚体：忽略四条腿形变对动力学的影响。
        
        1. 质量定义：密度在体积上的积分
           
            $$
            	\int_B \rho  \mathrm{~d} V=m
            $$
            
        2. 重心特性：
           
            $$
            	\int_B \rho \boldsymbol{p}_b \mathrm{~d} V=\mathbf{0}_{3 \times 1}
            $$
            
        3. 重心受到的合外力：牛顿第二定律。
           
            $$
            F=m\dot{v}
            $$
            
            - 推导过程
              
                对每一个质点进行积分：
                
                $$
                \boldsymbol{f}_b=\int_B \boldsymbol{\rho}(x, y, z) \ddot{\boldsymbol{p}}_b(x, y, z) \mathrm{d} V
                $$
                
                将$\ddot{\boldsymbol{p}}_P=\dot{\boldsymbol{v}}_b+\left[\dot{\boldsymbol{\omega}}_b\right]_{\times} \boldsymbol{p}_P+\left[\boldsymbol{\omega}_b\right]_{\times}\left[\boldsymbol{\omega}_b\right]_{\times} \boldsymbol{p}_P$代入上式，其中 $\dot{v_b}$和 $[\dot{\omega}]_{\times}$为常量，再带入质量定义、重心特性，即可得到牛顿第二定律公式。
            
        4. 重心受到的合外力矩：旋转刚体欧拉方程。
           
            $$
            \boldsymbol{m}_b=\boldsymbol{I}_b \dot{\boldsymbol{\omega}}_b+\left[\boldsymbol{\omega}_b\right]_{\times} \boldsymbol{I}_b \boldsymbol{\omega}_b
            $$
            
            第二项非线性，不好求解。但由于四足通常不会快速旋转，故可省去。
            
            - 推导过程：力矩 = 力臂 × 力（力臂与力的向量积）
              
                $$
                \begin{aligned}\boldsymbol{m}_b & =\int_B\left[\boldsymbol{p}_b\right]_{\times} \mathrm{d} \boldsymbol{f}=\int_B\left[\boldsymbol{p}_b\right]_{\times} \rho \ddot{\boldsymbol{p}}_b \mathrm{~d} V \\& =\int_B \rho\left[\boldsymbol{p}_b\right]_{\times}\left(\dot{\boldsymbol{v}}_b+\left[\dot{\omega}_b\right]_{\times} \boldsymbol{p}_b+\left[\boldsymbol{\omega}_b\right]_{\times}\left[\boldsymbol{\omega}_b\right]_{\times} \boldsymbol{p}_b\right) \mathrm{d} V \\& =\int_B \rho\left[\boldsymbol{p}_b\right]_{\times} \mathrm{d} V \dot{\boldsymbol{v}}_b+\int_B \rho\left[\boldsymbol{p}_b\right]_{\times}\left[\dot{\omega}_b\right]_{\times} \boldsymbol{p}_b \mathrm{~d} V+\int_B \rho\left[\boldsymbol{p}_b\right]_{\times}\left[\boldsymbol{\omega}_b\right]_{\times}\left[\boldsymbol{\omega}_b\right]_{\times} \boldsymbol{p}_b \mathrm{~d} V\end{aligned}
                $$
                
                之后再根据向量积的各种运算法则化简，即可得到欧拉方程。
            
        5. 惯性张量
           
            ![image.png](image/2025-12/image%209.png)
            
            惯性张量的坐标系转换：
            
            $$
            \boldsymbol{I}_s = \boldsymbol{R_{sb}}\boldsymbol{I_b}\boldsymbol{R_{sb}}^{T}
            $$
        
    2. 动能   ···················· P82
       
        移动动能：
        
        $$
        K_m = \frac{1}{2}m\boldsymbol{v}^{T}_b\boldsymbol{v}_b
        $$
        
        转动动能：
        
        $$
        K_t = \frac{1}{2}\boldsymbol{\omega}^{T}_b\boldsymbol{I_b}\boldsymbol{\omega}_b
        $$
        
    1. 足端动力学   ···················· P85
       
        重心的合力 = 重力 + 四个足端力之和
        
        重心的力矩 = 四足力矩之和
        
        （下面的公式包含从{b}坐标系到{s}坐标系的转换）
        
        公式形式：
        
        $$
        \left\{\begin{array}{l}m \boldsymbol{g}+\sum_{i=0}^n \boldsymbol{f}_{(i) s}=m \dot{\boldsymbol{v}}_s \\\sum^n_{i=0}\left[\boldsymbol{p}_{g(i)}\right]_{\times} f_{(i) s}=\boldsymbol{R}_{s b} \boldsymbol{I}_b \boldsymbol{R}_{s b}^{\mathrm{T}} \dot{\boldsymbol{\omega}}_s\end{array}\right.
        $$
        
        $$
        \boldsymbol{g}=[0,0,0.98]^T,n=3
        $$
        
        矩阵形式：
        
        $$
        \left[\begin{array}{cccc}\boldsymbol{I} & \boldsymbol{I} & \boldsymbol{I} & \boldsymbol{I} \\{\left[\boldsymbol{p}_{g0}\right]_{\times}} & {\left[\boldsymbol{p}_{g1}\right]_{\times}} & {\left[\boldsymbol{p}_{g2}\right]_{\times}} & {\left[\boldsymbol{p}_{g3}\right]_{\times}}\end{array}\right]\left[\begin{array}{l}\boldsymbol{f}_{0 s} \\\boldsymbol{f}_{1 s} \\\boldsymbol{f}_{2 s} \\\boldsymbol{f}_{3 s}\end{array}\right]=\left[\begin{array}{c}m\left(\dot{\boldsymbol{v}}_s-\boldsymbol{g}\right) \\\boldsymbol{R}_{s b} \boldsymbol{I}_b \boldsymbol{R}_{s b}^{\mathrm{T}} \dot{\boldsymbol{\omega}}_s\end{array}\right]
        $$
        
        上述公式中，机器人世界坐标系姿态 $R_{sb}$、运动状态 $\boldsymbol{v}_s$、 $\boldsymbol{\omega}_s$，需要通过观测来估计。
        
    
- 七、状态估计器
    1. IMU   ···················· P88
       
        组成与输出：加速计（加速度，姿态），陀螺仪（角速度）
        
        加速计原理：ma=-ks（质量*加速度=F=弹簧刚度*位移）
        
        IMU可以给出的量包括加速度 $\boldsymbol{a_s}$、角速度 $\boldsymbol{\omega_s}$、位姿 $\boldsymbol{R_{sb}}$
        
        $$
        \boldsymbol{a_s}=\boldsymbol{R_{sb}}\boldsymbol{a_{out}}+\boldsymbol{g}
        $$
        
    2. 离散状态空间模型   ···················· P89
       
       
        连续系统（ $\dot{x}$为为下一状态，不是导数）
        
        ![image.png](image/2025-12/image%2010.png)
        
        离散系统
        
        ![image.png](image/2025-12/image%2011.png)
        
        - $A$：系统矩阵
        - $B$：输入矩阵
        - $C$：输出矩阵
        
        （离散系统与连续系统的区别：）···················· P92
        
        ![image.png](image/2025-12/image%2012.png)
        
        1. 状态量：（及导数）
           
           
            ![image.png](image/2025-12/image%2013.png)
            
            ![image.png](image/2025-12/image%2014.png)
            
            - $p_b$：机身位置
            - $v_b$：机身速度
            - $p_i$：四个足端位置（导数部分假设足端静止）
            
        2. 控制量：
           
            假设机身加速度为控制量，则（ $\dot{x}$为为下一状态，不是导数）：
            
            ![image.png](image/2025-12/image%2015.png)
            
        3. 观测：
           
            ![image.png](image/2025-12/image%2016.png)
            
            - $\boldsymbol{p_{sfBi}}$：{s}下足端到机身位置向量（根据关节角度、机身姿态，关节角度可以得到关节坐标系下的足端位置，再通过一步机身姿态矩阵转换到{s}坐标系）
            - $\boldsymbol{v_{sfBi}}$：{s}下足端相对于机身的速度（根据6.3移动刚体的质点速度求得）
            - $p_{szi}$：足端高度（假设着地）
        
    3. 离散卡尔曼滤波 ···················· P99
       
        噪声模型：
        
        ![image.png](image/2025-12/image%2017.png)
        
        ![image.png](image/2025-12/image%2018.png)
        
        - $\boldsymbol{Q}$：过程噪声协方差
        - $\boldsymbol{R}$：观测噪声协方差
        
        求解步骤：
        
        ![image.png](image/2025-12/image%2019.png)
        
    4. 协方差测量 ···················· P100
       
        对于观测噪声 $\boldsymbol{R}$，易证机器人在静止状态时的噪声协方差等于观测协方差。
        
        对于过程噪声 $\boldsymbol{Q}$，其中一部分噪声是控制量引入的，控制量 $\boldsymbol{R_{sb}}\boldsymbol{a_b}$是IMU给出的结果，也有测量噪声。
        
    5. 参数调试 ···················· P103
        - 以同一比例缩放三个协方差矩阵的值， $\boldsymbol{Q}^{\prime}=a \boldsymbol{Q} 、 \boldsymbol{R}^{\prime}=a \boldsymbol{R} 、 \boldsymbol{P}_0^{+\prime}=a \boldsymbol{P}_0^{+}$，估计效果不会发生变化。
        - 某足端腾空时，观测噪声 $\boldsymbol{Q}$ 对应位置的值应该设置为 $+ \infin$。更精细的做法是利用分段函数，在开始触地与结束触地时，设置可变的协方差。
        - 一般 $\boldsymbol{R}$都可以直接测量得到，重点在于调节 $\boldsymbol{Q}$。先设置一个较大的值，如果估计结果较大震动，再逐渐缩小 $\boldsymbol{Q}$，直到合适为止。
    
- 八、平衡控制器
    1. 机身位姿反馈控制 ···················· P109
       
        通过控制力，结合6.6的足端动力学方程，来控制机身的线加速度和角加速度，进而控制机身在{s}中的位置和姿态。
        
        此处使用PD控制实现线/角加速度对位姿的控制（推导略）。 ···················· P112
        
        $$
        \ddot{\boldsymbol{p}}=\boldsymbol{K}_{\mathrm{p}} \Delta \boldsymbol{p}+\boldsymbol{K}_{\mathrm{d}} \Delta \dot{\boldsymbol{p}}
        $$
        
        - $\boldsymbol{p}$：位置； $\dot{\boldsymbol{p}}$：速度； $\ddot{\boldsymbol{p}}$：加速度； $\Delta \boldsymbol{p}$：位置偏差； $\Delta \boldsymbol{\dot{p}}$：速度偏差；
        - xyz可以分别控制。
        - 让机身产生符合上述等式的线加速度，位置和速度就能收敛到目标位置和目标速度。
        - $\boldsymbol{K}_{\mathrm{p}}<\frac{1}{(dt)^2}$，需要通过试验调节；得到$\boldsymbol{K}_{\mathrm{p}}$后， $\boldsymbol{K}_{\mathrm{d}}=2\sqrt{\boldsymbol{K}_{\mathrm{p}}}-\frac{dt}{2}\boldsymbol{K}_{\mathrm{p}}$。
        
        角加速度原理类似，只是xyz不能分别计算。让机身产生PD控制等式的角加速度，就能让机身收敛到目标姿态。
        
    2. 足端力控制的二次规划求解 ···················· P114
       
        对于6.6的足端动力学方程，目前已知除足端力以外的全部变量：
        
        （1）机器人重心到足端位置：状态估计器（第7章）。
        
        （2）机器人位姿：IMU（7.1节）
        
        （3）线加速度和角加速度：PD控制器（8.1节）
        
        其中，有6个等式，12个未知数，未知数数量>方程数量，解不唯一，需要二次规划。
        
        优化目标： ···················· P116
        
        （形如：）
        
        $$
        J=(\boldsymbol{A x}-\boldsymbol{b})^{\mathrm{T}} \boldsymbol{S}(\boldsymbol{A x}-\boldsymbol{b})+\boldsymbol{x}^{\mathrm{T}} \boldsymbol{W x}
        $$
        
        （实际：）
        
        - 第一项：6.6式等式两边相减趋近于0
        - 第二项：足端力尽量小
        - 第三项：当前足端力与上一状态足端力不要差别太大
        
        约束： ···················· P114
        
        （摩擦锥约束，右侧为矩阵形式）
        
        $$
        \left\{\begin{array}{c}-\mu F_z<F_x<\mu F_z \\-\mu F_z<F_y<\mu F_z \\0<F_z\end{array}\right.
        $$
        
        $$
        \left[\begin{array}{ccc}1 & 0 & \mu \\-1 & 0 & \mu \\0 & 1 & \mu \\0 & -1 & \mu \\0 & 0 & 1\end{array}\right] \boldsymbol{f}_{i s} \geqslant \mathbf{0}
        $$
        
    1. 关节实际控制 ···················· P117
       
        通过第5章的雅可比矩阵，将足端力转换回关节力矩，实现关节的实际控制。
        
    1. 转动惯量等需要大量测试调参。WBC不需要调参。
    
- 九、步态和轨迹规划
  
    stance-触底腿，swing-摆动腿
    
    1. 步态类型与触地系数 ···················· P122
       
        步态周期=P，触底系数=r。则触地时长T_stance=rP，腾空时长T_swing=(1-r)P。
        
        各种步态：
        
        - 对角步态（Trot）：相对的两只脚落地。此外，还分为步行对角步态（触地系数>0.5）和奔跑对角步态（触底系数<0.5）。
          
            ![image.png](image/2025-12/image%2020.png)
            
        - 跃进步态（Bound）：两条前腿同步运动，两条后腿同步运动。
        - 踱步步态（Pace）：两条左腿同步运动，两条右腿同步运动。
        - 弹跳步态（Pront）：四条腿同步运动。
          
            ![image.png](image/2025-12/image%2021.png)
            
        
    2. 落脚点规划 ···················· P125
       
        一条腿的运动图示：开始离地①→触地②→中立点③→下一次离地④
        
        ![image.png](image/2025-12/image%2022.png)
        
        $$
        \left\{\begin{array}{l}x_f=x_p(p)+v_x(1-p) T_{\text {swing }}+\frac{1}{2} v_x T_{\text {stance }}+k_x\left(v_x-v_{x d}\right) \\y_f=y_p(p)+v_y(1-p) T_{\text {swing }}+\frac{1}{2} v_y T_{\text {stance }}+k_y\left(v_y-v_{y d}\right)\end{array}\right.
        $$
        
        落地点可以拆分为x和y两个方向：
        
        - $\Delta x$：1/2触地时间*腿部速度，对应公式 $\frac{1}{2} v T_{\text {stance }}$部分。
        - 重心从①→②的距离：离地时间*腿部速度，但由于腿部速度非匀速，因此用时刻t的相位p（ $p_t=\frac{t-t_0}{t_1-t_0}$）对初始位置和中止位置加权得到。
        - 当机器人实际速度高于目标速度时，可再前移触地点（图中右移，对应公式 $k(v-v_{d})$部分），这样可以产生一个向后（图中向左）的加速度。
        
        （转动和平移的原理类似，略）
        
    3. 摆线轨迹的位置与速度 ···················· P128
       
        摆动轨迹的方法：多项式曲线、分段直线、摆线。
        
        摆线方法：（x与y原理一致）
        
        一个圆在地上滚动一周，初始触地点在空中的轨迹即为摆线。
        
        ![image.png](image/2025-12/image%2023.png)
        
        当滚动角= $\theta$时，初始触底点 $A_1$运动到 $A_2$位置，水平和垂直位移分别为：
        
        $$
        \left\{\begin{array}{l}x=R\left(\frac{2 \pi t}{T}-\sin \frac{2 \pi t}{T}\right) \\z=R\left(1-\cos \frac{2 \pi t}{T}\right)\end{array}\right.
        $$
        
        其中 $T$为滚动一圈的时间（离地时间）， $\frac{2 \pi t}{T}$为滚动角 $\theta$。对时间求导，即为摆线速度。
        
        假设足端从 $(x_0,y_0,z_0)$开始腾空到 $(x_1,y_1,z_1)$开始触地，上述圆周长 $2 \pi R=x_1-x_0$。解除水平移动距离与R的绑定，自定义足端最大高度为 $h$，同时将 $\frac{t}{T}$用相位 $p$表示，得到摆线轨迹位置公式：
        
        $$
        \left\{\begin{array}{l}x_c=x_0+\frac{x_1-x_0}{2 \pi}(2 \pi p-\sin 2 \pi p) \\y_c=y_0+\frac{y_1-y_0}{2 \pi}(2 \pi p-\sin 2 \pi p) \\z_c=z_0+\frac{h}{2}(1-\cos 2 \pi p)\end{array}\right.
        $$
        
        对时间求导得到摆线速度：
        
        $$
        \left\{\begin{array}{l}\dot{x}_c=\frac{x_1-x_0}{T}(1-\cos 2 \pi p) \\\dot{y}_c=\frac{y_1-y_0}{T}(1-\cos 2 \pi p) \\\dot{z}_c=\frac{\pi h}{T} \sin 2 \pi p\end{array}\right.
        $$
    
- 十、行走控制器
  
    结合前面几章的内容，就可以编写一个行走控制器。  ···················· P134
    
    1. 目标：使机器人机身到达用户输入的目标位置、目标速度、目标姿态和目标角速度（通过一个函数计算，比如手柄程序）。
    2. 根据当前设置的步态状态，规划四足各自支撑期和摆动期。摆动腿：落脚点规划和摆线规划（第9章）。支撑腿：触地静止。
    3. 单腿控制：
        1. 摆动腿：根据足端位置和足端速度计算关节角度和关节角速度，外加修正力（第5章）。
        2. 支撑腿：根据估计器和平衡控制器，计算支撑腿足端位置、速度、力（第6-8章）。进而转换为关节角度、角速度和力矩（5.4节）。
    4. 关节电机混合控制：关节角度、角速度和力矩的混合控制（第2章）。